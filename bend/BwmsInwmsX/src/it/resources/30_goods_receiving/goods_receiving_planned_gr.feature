#Author: pjohnke@inconso.de
#Keywords Summary : planned goods receiving process
@defaultdatabased
@goodsreceiving @planned

Feature: Goods Receiving Planned GR

  Background:
    Given set global: idSite = "RL1", idClient = "RK1"

  
  Scenario: planned goods receiving process
    Given GR300_UPDATE_DELIVERY created record with: numDeliveryNote = "ITEM_EP", datDeliveryNote = null, idSupplier = null, name = null, idTransportVehicle = null, nameDriver = null, truckLicensePlate = null
      And GR300_UPDATE_DELIVERY result is saved as "Delivery"
    Given GR300_UPDATE_DELIVERY_ITEM_EP creates record with: idInboundDelivery = key:Delivery, idArticle = "40067005", qtyDeliveryNote = 300, idBatch = null, tsBbd = null, idAdvice = null, numItemAdvice = null
      And GR300_UPDATE_DELIVERY_ITEM_EP is successful
    Given GR300_UPDATE_DELIVERY_ITEM_EP creates record with: idInboundDelivery = key:Delivery, idArticle = "40067007", qtyDeliveryNote = 1800, idBatch = null, tsBbd = null, idAdvice = null, numItemAdvice = null
      And GR300_UPDATE_DELIVERY_ITEM_EP is successful
     Then delivery has 2 delivery items
     When GR300_CREATE_RECEIVING is called with: idInboundDelivery = key:Delivery, numDeliveryNote = "ITEM_EP", idWorkCenter = "W-000", idTerminal = "IPC6475", idGoodsReceipt = null
     Then GR300_CREATE_RECEIVING result is saved as "Receiving"
      And receiving "Receiving" has: idGoodsReceipt = ignore, stat = "02", typGoodsReceipt = "DELIV", datGoodsReceipt = now, idTerminal = null, idWorkcenter = null, clUnplanned = null
     Then 1 sec is passed
# article 40067005
     Then RECEIVING_BOOK_RECEIVING_ITEM is called with: idWorkcenter = "W400-101", idTerminal = "IPC6475", idGoodsReceipt = key:Receiving, idArticle = null, numGoodsReceiptItem = 1, typLu = "EURO", artvar = "2", countEntities = 30.0, countGrippingUnit = null, qtyPerEntity = 10.0, qtyRemaining = null, qtyForBooking = 300.0, idBatch = null, tsBbd = null, typSpecialStock = null, idSpecialStock = null, storageArea = null, storageLocation = null, storeInZoneGroup = null, idLu = null, height = 50.0, repeatBooking = 1, controllerClass = "GR400"
      And RECEIVING_BOOK_RECEIVING_ITEM result has 1 load unit, saved as collection "Item0Lu"; result has: booking = true, isFinishedSetUp = false, qtyActual = 300.0
      And load unit "Item0Lu[0]" has: idLu = ignore, typLu = "EURO", statOccupied = "90", pctOccupied = 0.00, flgStockTaking = false, tsStockTaking = now, idUserStockTaking = "basis", storageArea = "H02-BLD", storageLocation = ignore, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", flgInTransit = true, idTransaction = ignore, sscc = ignore, wtGross = 223000.0, wtTare = 28000.0, height = 50.0, vol = 390000.0
      And load unit "Item0Lu[0]" has 1 quantum, saved as collection "Item0Lu[0]Qu"
      And quantum "Item0Lu[0]Qu[0]" has: idQuantum = ignore, idArticle = "40067005", qtyAvailable = 300.0, qtyReserved = 0.0, flgStockTaking = false, idLu1 = ignore, typLu1 = "EURO", storageArea = "H02-BLD", storageLocation = "", storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", flgInTransit = true, idTransaction = ignore, artvar = "2", typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, idGoodsReceipt = key:Receiving, numGoodsReceiptItem = 1, tsGoodsReceipt = now, wtGross = 195000.0, vol = 246000.0
      And load unit "Item0Lu[0]" has 1 bps record, saved as collection "Lu[0]BpsRecord"
      And bps record "Lu[0]BpsRecord[0]" has: idRecord = ignore, stat = "10", typ = "DEF", priorityOrig = 500, idRecordGrp = ignore, typStep = "TRANSPORT", statStep = "30", tsStartTargetMaxStep = now, tsEndTargetMax = now+0.02:00, numConsecStep = 2, idNode = "a96c13ed-9249-49c6-bc37-81fb20dd7749", idArticle = "40067005", qty = 300.0, artvar = "2", typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, wt = 223000.0, unitWt = "GR", vol = 390000.0, unitVol = "CBCM", idLuSrc = ignore, idQuantumSrc = ignore, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", storageAreaTgt = "H02-BLD", storageLocationTgt = ignore
      And bps record "Lu[0]BpsRecord[0]" has 5 steps, saved as collection "Lu[0]BpsRecord[0]BpsStep"
      And bps step "Lu[0]BpsRecord[0]BpsStep[0]" has: idRecord = ignore, numConsec = 1, statStep = "90", typStep = "SETUP", tsStartTargetMaxStep = now, idNode = "b51d3b3a-7c4c-43f0-a399-9330f157f4f0", tsStart = now, tsEnd = now
      And bps step "Lu[0]BpsRecord[0]BpsStep[1]" has: idRecord = ignore, numConsec = 2, statStep = "30", typStep = "TRANSPORT", tsStartTargetMaxStep = now, idNode = "751ea51e-8a73-436e-aaf2-c61473a296eb", tsStart = now, tsEnd = null   
      And bps step "Lu[0]BpsRecord[0]BpsStep[2]" has: idRecord = ignore, numConsec = 3, statStep = "00", typStep = "BOOKING", tsStartTargetMaxStep = now, idNode = "27ebbe5f-c8b7-4b07-aa97-55b6de38a71f", tsStart = null, tsEnd = null
      And bps step "Lu[0]BpsRecord[0]BpsStep[3]" has: idRecord = ignore, numConsec = 4, statStep = "00", typStep = "RESERV_MOVE", tsStartTargetMaxStep = now, idNode = "502a468f-a7fe-453a-ae92-36db0f4d230f", tsStart = null, tsEnd = null
      And bps step "Lu[0]BpsRecord[0]BpsStep[4]" has: idRecord = ignore, numConsec = 5, statStep = "00", typStep = "MESSAGE", tsStartTargetMaxStep = now, idNode = "d30227c2-97d8-44d9-99d8-d68ea1344ecb", tsStart = null, tsEnd = null
      And quantum "Item0Lu[0]Qu[0]" or load unit "Item0Lu[0]" has 4 transactions, saved as collection "Item0Lu[0]Transaction"
      And CRELU transaction "Item0Lu[0]Transaction[0]" has: idTransaction = ignore, stat = "90", situation = "GR_PLANNED", idCre = "basis", tsCre = now, storageAreaSrc = "QUELLE-LAG", storageLocationSrc = "Q-001", storageAreaTgt = "H01-WE", storageLocationTgt = "W-101", idLu = key:Item0Lu[0], typLu = "EURO", height = 50.0, vol = 144000.0, wt = 28000.0
      And CREQU transaction "Item0Lu[0]Transaction[1]" has: idTransaction = ignore, stat = "90", situation = "GR_PLANNED", idCre = "basis", tsCre = now, storageAreaSrc = "QUELLE-LAG", storageLocationSrc = "Q-001", storageAreaTgt = "H01-WE", storageLocationTgt = "W-101", idLu1 = key:Item0Lu[0], typLu1 = "EURO", idLu2 = null, typLu2 = null, idLu3 = null, typLu3 = null, height = 50.0, vol = 390000.0, wtGross = 223000.0, wtTare = 28000.0, idArticle = "40067005", qtyMoved = 300.0, idQuantum = key:Item0Lu[0]Qu[0], artvar = "2", volQuantum = 246000.0, wtGrossQuantum = 195000.0, typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", idBatch = null, tsBbd = null, sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, sepCrit04 = null, sepCrit05 = null, sepCrit06 = null, sepCrit07 = null, sepCrit08 = null, sepCrit09 = null, sepCrit10 = null, idSpecialStock = null, typSpecialStock = null, idGoodsReceipt = key:Receiving, numGoodsReceiptItem = 1, tsGoodsReceipt = now
      And RELLU transaction "Item0Lu[0]Transaction[2]" has: idTransaction = ignore, stat = "10", situation = "GR_FINISH", idCre = "basis", tsCre = now, idUpd = "basis", tsUpd = now, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", storageAreaTgt = "H02-BLD", storageLocationTgt = ignore, idLu = key:Item0Lu[0], idLu1 = key:Item0Lu[0], typLu1 = "EURO", idLu2 = null, typLu2 = null, idLu3 = null, typLu3 = null, height = 50.0, vol = 390000.0, wtGross = 223000.0, wtTare = 28000.0, idArticle = null, idQuantum = null, artvar = null, volQuantum = null, wtGrossQuantum = null, qtyAvailable = null, qtyReserved = null, typStock = null, typLock = null, statQualityControl = null, statCustoms = null, idBatch = null, tsBbd = null, sepCrit01 = null, sepCrit02 = null, sepCrit03 = null, sepCrit04 = null, sepCrit05 = null, sepCrit06 = null, sepCrit07 = null, sepCrit08 = null, sepCrit09 = null, sepCrit10 = null, idSpecialStock = null, typSpecialStock = null, idGoodsReceipt = null, numGoodsReceiptItem = null, tsGoodsReceipt = null, typRelocation = "TRANSPORT"
      And RELLU transaction "Item0Lu[0]Transaction[3]" has: idTransaction = ignore, stat = "10", situation = "GR_FINISH", idCre = "basis", tsCre = now, idUpd = "basis", tsUpd = now, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", storageAreaTgt = "H02-BLD", storageLocationTgt = ignore, idLu = key:Item0Lu[0], idLu1 = key:Item0Lu[0], typLu1 = "EURO", idLu2 = null, typLu2 = null, idLu3 = null, typLu3 = null, height = 50.0, vol = 390000.0, wtGross = 223000.0, wtTare = 28000.0, idArticle = "40067005", idQuantum = key:Item0Lu[0]Qu[0], artvar = "2", volQuantum = 246000.0, wtGrossQuantum = 195000.0, qtyAvailable = 300.0, qtyReserved = 0.0, typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", idBatch = null, tsBbd = null, sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, sepCrit04 = null, sepCrit05 = null, sepCrit06 = null, sepCrit07 = null, sepCrit08 = null, sepCrit09 = null, sepCrit10 = null, idSpecialStock = null, typSpecialStock = null, idGoodsReceipt = key:Receiving, numGoodsReceiptItem = 1, tsGoodsReceipt = now, typRelocation = "TRANSPORT"
      And transactions have same idTransactionGrp:
        | Item0Lu[0]Transaction[2] |
        | Item0Lu[0]Transaction[3] |
      And bps record "Lu[0]BpsRecord[0]" has one receiving item, saved as "ReceivingItem[0]"
      And receiving item "ReceivingItem[0]" has: idGoodsReceipt = key:Receiving, numItem = 1, stat = "30", idArticle = "40067005", artvar = null, qtyDeliveryNote = 300.0, qtyTarget = 300.0, qtyCanceled = 0.0, qtyActual = 300.0, sepCrit03 = key:Receiving
      And bps record "Lu[0]BpsRecord[0]" has: typRef = "GR_RECEIVING_ITEM", matches "ReceivingItem[0]"
      And load unit "Item0Lu[0]" has 1 transport task, saved as collection "Lu[0]Task"
      And COMPLETE_TASK_EP is called with transport task "Lu[0]Task[0]"
     Then reload bps record "Lu[0]BpsRecord[0]"
      And reload transport task "Lu[0]Task[0]"
      And transport task "Lu[0]Task[0]" has: idTask = ignore, stat = "90", priority = ignore, typLu = "EURO", storageArea = "H01-WE", storageLocation = "W-101", clProcess = "GR", typProcess = "SETUP", stepProcess = "FINISH"

# article 40067007
     Then RECEIVING_BOOK_RECEIVING_ITEM is called with: idWorkcenter = "W400-101", idTerminal = "IPC6475", idGoodsReceipt = key:Receiving, idArticle = null, numGoodsReceiptItem = 2, typLu = "EURO", artvar = "1", countEntities = null, countGrippingUnit = null, qtyPerEntity = null, qtyRemaining = null, qtyForBooking = 1800.0, idBatch = null, tsBbd = null, typSpecialStock = null, idSpecialStock = null, storageArea = null, storageLocation = null, storeInZoneGroup = null, idLu = null, height = 50.0, repeatBooking = 1, controllerClass = "GR400"
      And RECEIVING_BOOK_RECEIVING_ITEM result has 1 load unit, saved as collection "Item1Lu"; result has: booking = true, isFinishedSetUp = true, qtyActual = 1800.0
      And load unit "Item1Lu[0]" has: idLu = ignore, typLu = "EURO", statOccupied = "90", pctOccupied = 0.00, flgStockTaking = false, tsStockTaking = now, idUserStockTaking = "basis", storageArea = "H02-BLD", storageLocation = ignore, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", flgInTransit = true, idTransaction = ignore, sscc = ignore, wtGross = 371800.0, wtTare = 28000.0, height = 50.0, vol = 1051200.0
      And load unit "Item1Lu[0]" has 1 quantum, saved as collection "Item1Lu[0]Qu"
      And quantum "Item1Lu[0]Qu[0]" has: idQuantum = ignore, idArticle = "40067007", qtyAvailable = 1800.0, qtyReserved = 0.0, flgStockTaking = false, idLu1 = ignore, typLu1 = "EURO", storageArea = "H02-BLD", storageLocation = "", storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", flgInTransit = true, idTransaction = ignore, artvar = "1", typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, idGoodsReceipt = key:Receiving, numGoodsReceiptItem = 2, tsGoodsReceipt = now, wtGross = 343800.0, vol = 907200.0
      And load unit "Item1Lu[0]" has 1 bps record, saved as collection "Lu[1]BpsRecord"
      And bps record "Lu[1]BpsRecord[0]" has: idRecord = ignore, stat = "10", typ = "DEF", priorityOrig = 500, idRecordGrp = ignore, typStep = "TRANSPORT", statStep = "30", tsStartTargetMaxStep = now, tsEndTargetMax = now+0.02:00, numConsecStep = 2, idNode = "a96c13ed-9249-49c6-bc37-81fb20dd7749", idArticle = "40067007", qty = 1800.0, artvar = "1", typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, wt = 371800.0, unitWt = "GR", vol = 1051200.0, unitVol = "CBCM", idLuSrc = ignore, idQuantumSrc = ignore, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", storageAreaTgt = "H02-BLD", storageLocationTgt = ignore
      And bps record "Lu[1]BpsRecord[0]" has 5 steps, saved as collection "Lu[1]BpsRecord[0]BpsStep"
      And bps step "Lu[1]BpsRecord[0]BpsStep[0]" has: idRecord = ignore, numConsec = 1, statStep = "90", typStep = "SETUP", tsStartTargetMaxStep = now, idNode = "b51d3b3a-7c4c-43f0-a399-9330f157f4f0", tsStart = now, tsEnd = now
      And bps step "Lu[1]BpsRecord[0]BpsStep[1]" has: idRecord = ignore, numConsec = 2, statStep = "30", typStep = "TRANSPORT", tsStartTargetMaxStep = now, idNode = "751ea51e-8a73-436e-aaf2-c61473a296eb", tsStart = now, tsEnd = null
      And bps step "Lu[1]BpsRecord[0]BpsStep[2]" has: idRecord = ignore, numConsec = 3, statStep = "00", typStep = "BOOKING", tsStartTargetMaxStep = now, idNode = "27ebbe5f-c8b7-4b07-aa97-55b6de38a71f", tsStart = null, tsEnd = null
      And bps step "Lu[1]BpsRecord[0]BpsStep[3]" has: idRecord = ignore, numConsec = 4, statStep = "00", typStep = "RESERV_MOVE", tsStartTargetMaxStep = now, idNode = "502a468f-a7fe-453a-ae92-36db0f4d230f", tsStart = null, tsEnd = null
      And bps step "Lu[1]BpsRecord[0]BpsStep[4]" has: idRecord = ignore, numConsec = 5, statStep = "00", typStep = "MESSAGE", tsStartTargetMaxStep = now, idNode = "d30227c2-97d8-44d9-99d8-d68ea1344ecb", tsStart = null, tsEnd = null
      And quantum "Item1Lu[0]Qu[0]" or load unit "Item1Lu[0]" has 4 transactions, saved as collection "Item1Lu[0]Transaction"
      And CRELU transaction "Item1Lu[0]Transaction[0]" has: idTransaction = ignore, stat = "90", situation = "GR_PLANNED", idCre = "basis", tsCre = now, storageAreaSrc = "QUELLE-LAG", storageLocationSrc = "Q-001", storageAreaTgt = "H01-WE", storageLocationTgt = "W-101", idLu = key:Item1Lu[0], typLu = "EURO", height = 50.0, vol = 144000.0, wt = 28000.0
      And CREQU transaction "Item1Lu[0]Transaction[1]" has: idTransaction = ignore, stat = "90", situation = "GR_PLANNED", idCre = "basis", tsCre = now, storageAreaSrc = "QUELLE-LAG", storageLocationSrc = "Q-001", storageAreaTgt = "H01-WE", storageLocationTgt = "W-101", idLu1 = key:Item1Lu[0], typLu1 = "EURO", idLu2 = null, typLu2 = null, idLu3 = null, typLu3 = null, height = 50.0, vol = 1051200.0, wtGross = 371800.0, wtTare = 28000.0, idArticle = "40067007", qtyMoved = 1800.0, idQuantum = key:Item1Lu[0]Qu[0], artvar = "1", volQuantum = 907200.0, wtGrossQuantum = 343800.0, typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", idBatch = null, tsBbd = null, sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, sepCrit04 = null, sepCrit05 = null, sepCrit06 = null, sepCrit07 = null, sepCrit08 = null, sepCrit09 = null, sepCrit10 = null, idSpecialStock = null, typSpecialStock = null, idGoodsReceipt = key:Receiving, numGoodsReceiptItem = 2, tsGoodsReceipt = now
      And RELLU transaction "Item1Lu[0]Transaction[2]" has: idTransaction = ignore, stat = "10", situation = "GR_FINISH", idCre = "basis", tsCre = now, idUpd = "basis", tsUpd = now, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", storageAreaTgt = "H02-BLD", storageLocationTgt = ignore, idLu = key:Item1Lu[0], idLu1 = key:Item1Lu[0], typLu1 = "EURO", idLu2 = null, typLu2 = null, idLu3 = null, typLu3 = null, height = 50.0, vol = 1051200.0, wtGross = 371800.0, wtTare = 28000.0, idArticle = null, idQuantum = null, artvar = null, volQuantum = null, wtGrossQuantum = null, qtyAvailable = null, qtyReserved = null, typStock = null, typLock = null, statQualityControl = null, statCustoms = null, idBatch = null, tsBbd = null, sepCrit01 = null, sepCrit02 = null, sepCrit03 = null, sepCrit04 = null, sepCrit05 = null, sepCrit06 = null, sepCrit07 = null, sepCrit08 = null, sepCrit09 = null, sepCrit10 = null, idSpecialStock = null, typSpecialStock = null, idGoodsReceipt = null, numGoodsReceiptItem = null, tsGoodsReceipt = null, typRelocation = "TRANSPORT"
      And RELLU transaction "Item1Lu[0]Transaction[3]" has: idTransaction = ignore, stat = "10", situation = "GR_FINISH", idCre = "basis", tsCre = now, idUpd = "basis", tsUpd = now, storageAreaSrc = "H01-WE", storageLocationSrc = "W-101", storageAreaTgt = "H02-BLD", storageLocationTgt = ignore, idLu = key:Item1Lu[0], idLu1 = key:Item1Lu[0], typLu1 = "EURO", idLu2 = null, typLu2 = null, idLu3 = null, typLu3 = null, height = 50.0, vol = 1051200.0, wtGross = 371800.0, wtTare = 28000.0, idArticle = "40067007", idQuantum = key:Item1Lu[0]Qu[0], artvar = "1", volQuantum = 907200.0, wtGrossQuantum = 343800.0, qtyAvailable = 1800.0, qtyReserved = 0.0, typStock = "RC", typLock = "------", statQualityControl = "00", statCustoms = "00", idBatch = null, tsBbd = null, sepCrit01 = "0011", sepCrit02 = "0220", sepCrit03 = ignore, sepCrit04 = null, sepCrit05 = null, sepCrit06 = null, sepCrit07 = null, sepCrit08 = null, sepCrit09 = null, sepCrit10 = null, idSpecialStock = null, typSpecialStock = null, idGoodsReceipt = key:Receiving, numGoodsReceiptItem = 2, tsGoodsReceipt = now, typRelocation = "TRANSPORT"
      And transactions have same idTransactionGrp:
        | Item1Lu[0]Transaction[2] |
        | Item1Lu[0]Transaction[3] |
      And bps record "Lu[1]BpsRecord[0]" has one receiving item, saved as "ReceivingItem[1]"
      And receiving item "ReceivingItem[1]" has: idGoodsReceipt = key:Receiving, numItem = 2, stat = "30", idArticle = "40067007", artvar = null, qtyDeliveryNote = 1800.0, qtyTarget = 1800.0, qtyCanceled = 0.0, qtyActual = 1800.0, sepCrit03 = key:Receiving
      And bps record "Lu[1]BpsRecord[0]" has: typRef = "GR_RECEIVING_ITEM", matches "ReceivingItem[1]"
      And load unit "Item1Lu[0]" has 1 transport task, saved as collection "Lu[1]Task"
      And COMPLETE_TASK_EP is called with transport task "Lu[1]Task[0]"
     Then reload bps record "Lu[1]BpsRecord[0]"
      And reload transport task "Lu[1]Task[0]"
      And transport task "Lu[1]Task[0]" has: idTask = ignore, stat = "90", priority = ignore, typLu = "EURO", storageArea = "H01-WE", storageLocation = "W-101", clProcess = "GR", typProcess = "SETUP", stepProcess = "FINISH"

     Then reload receiving item "ReceivingItem[0]"
      And receiving item "ReceivingItem[0]" has: idGoodsReceipt = key:Receiving, numItem = 1, stat = "90", idArticle = "40067005", artvar = null, qtyDeliveryNote = 300.0, qtyTarget = 300.0, qtyCanceled = 0.0, qtyActual = 300.0, sepCrit03 = key:Receiving
     Then reload receiving item "ReceivingItem[1]"
      And receiving item "ReceivingItem[1]" has: idGoodsReceipt = key:Receiving, numItem = 2, stat = "90", idArticle = "40067007", artvar = null, qtyDeliveryNote = 1800.0, qtyTarget = 1800.0, qtyCanceled = 0.0, qtyActual = 1800.0, sepCrit03 = key:Receiving

     Then reload receiving "Receiving"
      And receiving "Receiving" has: idGoodsReceipt = ignore, stat = "90", typGoodsReceipt = "DELIV", datGoodsReceipt = now, idTerminal = "IPC6475", idWorkcenter = "W400-101", clUnplanned = null

#Clean up
			Then delete load unit "Item1Lu[0]"
			Then delete load unit "Item0Lu[0]"