<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
 <HEAD>
 <LINK REL="STYLESHEET" TYPE="text/css" HREF="../../plsqldoc.css">
 <TITLE>View STM_V_STOCK_TAKING_ZONE</TITLE>
 <META name="object" content="VIEW">
 <META name="name" content="10.9.92.109:1521/INCOMPD INWMS.STM_V_STOCK_TAKING_ZONE">
 <META name="description" content="">
 <META name="columns" content="ID_SITE ID_STOCK_TAKING_ZONE FLG_ACTIVE TXT_LABEL FLG_LOCK_STORAGE_LOCATION FLG_COUNT_ZERO FLG_TRANSFER_LU_DATE CNT_TOTAL CNT_LU_TOTAL CNT_COUNTED CNT_LU_COUNTED CNT_LU_OPEN CNT_OPEN CNT_ACTUAL CNT_LU_ACTUAL PCT_COUNTED PCT_LU_COUNTED ID_CRE TS_CRE ID_UPD TS_UPD">
</HEAD>
<BODY>
<TABLE WIDTH="100%"><TR>
<TD><P ALIGN="LEFT"><STRONG><SMALL>INWMS@10.9.92.109:1521/INCOMPD</SMALL></STRONG></TD>
<TD><P ALIGN="RIGHT"><STRONG><SMALL><A HREF="../../index.html">index</A></SMALL></STRONG></TD>
</TR></TABLE>
<TABLE CLASS="MAIN_TABLE"><TR><TD CLASS="DESC_TEXT">
<P CLASS="MAIN_TITLE">View STM_V_STOCK_TAKING_ZONE</P>

</TD></TR></TABLE>
<HR>
<A NAME="Columns"></A>
<TABLE CLASS="SUB_TABLE"><TR><TD CLASS="SUB_TITLE">
Columns
</TD></TR></TABLE>
<TABLE CLASS="SIMPLE_TABLE">
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM"><U>
Name
</U>
</TD>
<TD VALIGN="TOP" CLASS="LIST_ITEM"><U>
Type
</U>
</TD>
<TD VALIGN="TOP" CLASS="LIST_ITEM"><U>
Optional
</U>
</TD>
<TD VALIGN="TOP" CLASS="LIST_ITEM"><U>
Default
</U>
</TD>
<TD VALIGN="TOP" CLASS="LIST_ITEM"><U>
Comments
</U>
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
ID_SITE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(48)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
ID_STOCK_TAKING_ZONE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(48)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
FLG_ACTIVE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(4)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
TXT_LABEL
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(160)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
FLG_LOCK_STORAGE_LOCATION
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(4)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
FLG_COUNT_ZERO
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(4)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
FLG_TRANSFER_LU_DATE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(4)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_TOTAL
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_LU_TOTAL
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_COUNTED
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_LU_COUNTED
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_LU_OPEN
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_OPEN
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_ACTUAL
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
CNT_LU_ACTUAL
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
PCT_COUNTED
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
PCT_LU_COUNTED
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
NUMBER
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
Y
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
ID_CRE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(160)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
TS_CRE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
DATE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
ID_UPD
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
VARCHAR2(160)
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
<TR>
<TD VALIGN="TOP" CLASS="LIST_ITEM">
TS_UPD
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
DATE
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
<TD VALIGN="TOP" CLASS="DESC_TEXT">
&nbsp;
</TD>
</TR>
</TABLE>
<HR>
<A NAME="SQL"></A>
<TABLE CLASS="SUB_TABLE"><TR><TD CLASS="SUB_TITLE">
SQL
</TD></TR></TABLE><PRE CLASS="DECL_TEXT">
create or replace view stm_v_stock_taking_zone as
with stock_taking_zone as (select z.id_site,
                                  z.id_stock_taking_zone,
                                  z.flg_active,
                                  z.txt_label,
                                  z.flg_lock_storage_location,
                                  z.flg_count_zero,
                                  z.flg_transfer_lu_date,
                                  z.id_cre,
                                  z.ts_cre,
                                  z.id_upd,
                                  z.ts_upd,
                                  count(sl.storage_location) as cnt_total
                             from top_stock_taking_zone z,
                                  top_storage_location sl
                            where z.flg_active               = '1'
                              and sl.id_site              (+)= z.id_site
                              and sl.id_stock_taking_zone (+)= z.id_stock_taking_zone
                         group by z.id_site,
                                  z.id_stock_taking_zone,
                                  z.flg_active,
                                  z.txt_label,
                                  z.flg_lock_storage_location,
                                  z.flg_count_zero,
                                  z.flg_transfer_lu_date,
                                  z.id_cre,
                                  z.ts_cre,
                                  z.id_upd,
                                  z.ts_upd
                          ),
       cnt_lu_total as    (select z.id_site,
                                  z.id_stock_taking_zone,
                                  count (lu.id_lu) as cnt_lu_total
                             from top_stock_taking_zone z,
                                  top_storage_location sl,
                                  im_load_unit lu
                            where z.flg_active               = '1'
                              and sl.id_site              (+)= z.id_site
                              and sl.id_stock_taking_zone (+)= z.id_stock_taking_zone
                              and lu.id_site (+)= sl.id_site
                              and lu.storage_area (+)= sl.storage_area
                              and lu.storage_location (+)= sl.storage_location
                              and lu.id_lu = (select distinct qu.id_lu_1 from im_quantum qu where qu.id_site = lu.id_site and qu.id_lu_1 = lu.id_lu)
                         group by z.id_site,
                                  z.id_stock_taking_zone
                          ),
       cnt_counted     as (select z.id_site,
                                  z.id_stock_taking_zone,
                                  count(sl.storage_location) as cnt_counted
                             from stock_taking_zone z,
                                  wb_site s,
                                  top_storage_location sl
                            where s.id_site                  = z.id_site
                              and sl.id_site              (+)= z.id_site
                              and sl.id_stock_taking_zone (+)= z.id_stock_taking_zone
                              and sl.ts_stock_taking      (+)>= add_months(to_date(s.num_stock_taking_day ||'.'|| s.num_stock_taking_month ||'.'|| extract(year from sysdate)), -12)
                            group by z.id_site,
                                     z.id_stock_taking_zone
                          ),
       -- actual locations with open stock taking items
       cnt_actual      as (select z.id_site,
                                  z.id_stock_taking_zone,
                                  count(sl.storage_location) as cnt_actual
                             from top_stock_taking_zone z,
                                  top_storage_location sl,
                                  stm_stock_taking_item i
                            where sl.id_site              = z.id_site
                              and sl.id_stock_taking_zone = z.id_stock_taking_zone
                              and i.id_site               = sl.id_site
                              and i.storage_area          = sl.storage_area
                              and i.storage_location      = sl.storage_location
                              and i.stat                  < '80'
                         group by z.id_site,
                                  z.id_stock_taking_zone
                          ),
       cnt_lu_counted  as (select z.id_site,
                                  z.id_stock_taking_zone,
                                  count(lu.id_lu) as cnt_lu_counted
                             from stock_taking_zone z,
                                  wb_site s,
                                  top_storage_location sl,
                                  im_load_unit lu
                            where s.id_site                  = z.id_site
                              and sl.id_site              (+)= z.id_site
                              and sl.id_stock_taking_zone (+)= z.id_stock_taking_zone
                              and sl.ts_stock_taking      (+)>= add_months(to_date(s.num_stock_taking_day ||'.'|| s.num_stock_taking_month ||'.'|| extract(year from sysdate)), -12)
                              and lu.id_site              (+)= sl.id_site
                              and lu.storage_area         (+)= sl.storage_area
                              and lu.storage_location     (+)= sl.storage_location
                              and lu.id_lu = (select distinct qu.id_lu_1 from im_quantum qu where qu.id_site = lu.id_site and qu.id_lu_1 = lu.id_lu)
                            group by z.id_site,
                                     z.id_stock_taking_zone
                          ),
        cnt_lu_actual      as (select z.id_site,
                                  z.id_stock_taking_zone,
                                  count(lu.id_lu) as cnt_lu_actual
                             from top_stock_taking_zone z,
                                  top_storage_location sl,
                                  stm_stock_taking_item i,
                                  im_load_unit lu
                            where sl.id_site              = z.id_site
                              and sl.id_stock_taking_zone = z.id_stock_taking_zone
                              and i.id_site               = sl.id_site
                              and i.storage_area          = sl.storage_area
                              and i.storage_location      = sl.storage_location
                              and lu.id_site              = sl.id_site
                              and lu.storage_area         = sl.storage_area
                              and lu.storage_location     = sl.storage_location
                              and lu.id_lu = (select distinct qu.id_lu_1 from im_quantum qu where qu.id_site = lu.id_site and qu.id_lu_1 = lu.id_lu)
                              and i.stat                  < '80'
                         group by z.id_site,
                                  z.id_stock_taking_zone
                          )
select z.id_site,
       z.id_stock_taking_zone,
       z.flg_active,
       z.txt_label,
       z.flg_lock_storage_location,
       z.flg_count_zero,
       z.flg_transfer_lu_date,
       z.cnt_total,
       coalesce(d.cnt_lu_total,0) as cnt_lu_total,
       coalesce(c.cnt_counted, 0) as cnt_counted,
       coalesce(e.cnt_lu_counted, 0) as cnt_lu_counted,
       greatest(coalesce(d.cnt_lu_total,0) - coalesce(cnt_lu_counted,0) - coalesce(cnt_lu_actual, 0), 0) as cnt_lu_open,
       greatest(z.cnt_total - cnt_counted - coalesce(cnt_actual, 0), 0) as cnt_open,
       coalesce(a.cnt_actual, 0.001) as cnt_actual,
       coalesce(f.cnt_lu_actual, 0.001) as cnt_lu_actual,
       case when z.cnt_total = 0 then 0 else (100 * c.cnt_counted / z.cnt_total) end as pct_counted,
       coalesce((100 * cnt_lu_counted / cnt_lu_total),0) as pct_lu_counted,
       z.id_cre,
       z.ts_cre,
       z.id_upd,
       z.ts_upd
from   stock_taking_zone z,
       cnt_counted c,
       cnt_actual a,
       cnt_lu_total d,
       cnt_lu_counted e,
       cnt_lu_actual f
--merge the internal statements to avoid cartesion product
where  c.id_site                 = z.id_site
  and  c.id_stock_taking_zone    = z.id_stock_taking_zone
  and  a.id_site              (+)= z.id_site
  and  a.id_stock_taking_zone (+)= z.id_stock_taking_zone
  and  d.id_site              (+)= z.id_site
  and  d.id_stock_taking_zone (+)= z.id_stock_taking_zone
  and  e.id_site              (+)= z.id_site
  and  e.id_stock_taking_zone (+)= z.id_stock_taking_zone
  and  f.id_site              (+)= z.id_site
  and  f.id_stock_taking_zone (+)= z.id_stock_taking_zone
;
</PRE>
<P>&nbsp;</P>
<P>&nbsp;</P>
</BODY>
</HTML>
